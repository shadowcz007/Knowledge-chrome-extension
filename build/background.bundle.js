(()=>{console.log("This is the background page."),console.log("Put the background scripts here.",chrome.contextMenus);let e,t=!1;const{notionToken:r,notionDatabaseId:o}=chrome.runtime.getManifest().config;async function n(e="",t={}){return(await fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer "+r,"Content-Type":"application/json","Notion-Version":"2022-06-28"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)})).json()}function s(e){return n(`https://api.notion.com/v1/databases/${o}/query`,{filter:{property:"tags",multi_select:{contains:e}},sorts:[{property:"createdAt",direction:"descending"}]})}function a(e){return[{pageTitle:e.properties.pageTitle.title[0]?.plain_text,pageId:e.properties.pageId.rich_text[0]?.plain_text,createdAt:e.properties.createdAt.rich_text[0]?.plain_text,reply:e.properties.reply.rich_text[0]?.plain_text,cfxAddress:e.properties.cfxAddress.rich_text[0]?.plain_text,nodeName:"#text",textContent:e.properties.textContent.rich_text[0]?.plain_text,tags:Array.from(e.properties.tags.multi_select,(e=>({color:e.color,name:e.name,id:e.id})))}]}console.log(r,o),chrome.runtime.onInstalled.addListener((async()=>{chrome.contextMenus.create({id:"mark",title:"标注",type:"normal",contexts:["selection"]}),chrome.storage.local.get().then((function(e){null==e.data&&chrome.storage.local.set({data:["元宇宙","人工智能","web3","Web3","大模型"]})}),(function(e){console.log(e)}))})),chrome.contextMenus.onClicked.addListener((async(t,r)=>{const o=t.menuItemId;if(console.log(o,t,r),"keyword"==o){chrome.storage.local.get().then((function(e){console.log(e);let r=[...e.data,t.selectionText.trim()];chrome.storage.local.set({data:r})}),(function(e){console.log(e)}))}else if("mark"==o){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e?chrome.tabs.sendMessage(r.id,{cmd:"mark-run",tabId:r.id},(function(e){console.log(e)})):chrome.tabs.sendMessage(r.id,{cmd:"login",tabId:r.id},(function(e){console.log(e)}))}})),chrome.runtime.onMessage.addListener((async function(r,c,i){if(console.log("收到来自content-script的消息："),console.log(r,c,i),"mark-result"==r.cmd){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e?function(e){let t={parent:{database_id:o},properties:{pageTitle:{title:[{type:"text",text:{content:e.pageTitle}}]},cfxAddress:{rich_text:[{type:"text",text:{content:e.cfxAddress}}]},pageId:{rich_text:[{type:"text",text:{content:e.pageId}}]},reply:{rich_text:[{type:"text",text:{content:e.reply}}]},textContent:{rich_text:[{type:"text",text:{content:e.textContent}}]},createdAt:{rich_text:[{type:"text",text:{content:e.createdAt}}]}}};return e.tags&&(t.properties.tags={multi_select:Array.from(e.tags,(e=>({name:e})))}),n("https://api.notion.com/v1/pages",t)}({...r.data,cfxAddress:e}).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"mark-push",data:a(e)},(function(e){console.log(e.farewell)}))}))})):console.log("请登录")}else if("cfx-address"==r.cmd)e=r.data,e&&chrome.storage.sync.set({cfxAddress:e});else if("get-address"==r.cmd){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e&&i(e)}else"get-by-pageId"==r.cmd?(d=r.data,n(`https://api.notion.com/v1/databases/${o}/query`,{filter:{property:"pageId",rich_text:{contains:d}}})).then((e=>{let t={},r=Array.from(e.results,(e=>{let r=a(e)[0];return Array.from(r.tags,(e=>t[e.name]=1)),r}));(function(e){let t={};return new Promise(((r,o)=>{e?s(e).then((o=>{Array.from(o.results,(r=>{let o=a(r)[0];t[o.pageId]={tag:e,pageTitle:o.pageTitle,pageId:o.pageId}})),r(Object.values(t))})):r()}))})(Object.keys(t)[0]).then((e=>{e&&Array.from(r,(t=>{t.relate=e.filter((e=>t.tags.filter((t=>t.name==e.tag)).length>0&&e.pageId!=t.pageId))})),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{cmd:"get-by-pageId-result",data:r},(function(e){console.log(e)}))}))}))})):"new-reply"==r.cmd?(console.log(r),function(e=null){isQueryNotEmptyOfReply=!0;let t=`https://api.notion.com/v1/databases/${o}/query`,r=[{property:"createdAt",direction:"descending"}],s={and:[{property:"reply",rich_text:{is_not_empty:!0}}]};return"this_week"==e?(s.and.push({timestamp:"created_time",created_time:{this_week:{}}}),r=[{property:"tags",direction:"ascending"}]):"past_week"==e&&(s.and.push({timestamp:"created_time",created_time:{past_week:{}}}),r=[{property:"tags",direction:"ascending"}]),n(t,{filter:s,sorts:r})}(r.timestamp).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"new-reply",data:Array.from(e.results,(e=>a(e)[0]))},(function(e){console.log(e)}))}))}))):(r.cmd=0==t)?(chrome.tabs.create({url:"newtab.html"}),t=!0):"find-by-tag"==r.cmd&&r.data&&s(r.data).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"find-by-tag-result",data:Array.from(e.results,(e=>a(e)[0]))},(function(e){console.log(e)}))}))}));var d;i("我是后台，我已收到你的消息："+JSON.stringify(r))}))})();