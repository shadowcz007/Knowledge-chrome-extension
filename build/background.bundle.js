(()=>{console.log("This is the background page."),console.log("Put the background scripts here.",chrome.contextMenus);let e,t=!1;const{notionToken:r,notionDatabaseId:s}=chrome.runtime.getManifest().config;console.log(r,s,chrome.action);const n=`https://api.notion.com/v1/databases/${s}/query`;chrome.runtime.onInstalled.addListener((async()=>{chrome.storage.sync.clear(),chrome.storage.local.clear(),chrome.contextMenus.create({id:"mark",title:"标注",type:"normal",contexts:["selection"]})})),chrome.action.onClicked.addListener((function(e){console.log("browserAction.onClicked"),chrome.tabs.create({url:chrome.runtime.getURL("options.html")},(function(e){})),i().then((e=>o(e)))})),chrome.contextMenus.onClicked.addListener((async(t,r)=>{const s=t.menuItemId;if(console.log(s,t,r),"keyword"==s){chrome.storage.local.get().then((function(e){console.log(e);let r=[...e.data,t.selectionText.trim()];chrome.storage.local.set({data:r})}),(function(e){console.log(e)}))}else if("mark"==s){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&t.cfxAddress.address&&(e=t.cfxAddress.address),e?chrome.tabs.sendMessage(r.id,{cmd:"mark-run",tabId:r.id},(function(e){console.log(e)})):chrome.tabs.sendMessage(r.id,{cmd:"login",tabId:r.id},(function(e){console.log(e)}))}}));function o(e=[]){let t={};return new Promise(((r,s)=>{chrome.storage.local.get("tags").then(((s,n)=>{s&&s.tags&&(t={...s.tags}),e&&e.length>0?(Array.from(e,(e=>{Array.from(e.tags,(r=>{t[r.name]=e}))})),chrome.storage.local.set({tags:t}).then((()=>r(t)))):r(t)}))}))}async function c(e="",t={}){const s=await((e,t={},r=1e4)=>{let s=!1;return new Promise((function(n,o){const c=setTimeout((function(){s=!0,n()}),r);fetch(e,t).then((e=>{clearTimeout(c),s||n(e)})).catch((e=>{n()}))}))})(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer "+r,"Content-Type":"application/json","Notion-Version":"2022-06-28"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});if(s&&200==s.status){let e=await s.json();return e&&e.properties&&(e.results=[{properties:e.properties}]),e=Array.from(e&&e.results?e.results:[],(e=>function(e){return[{pageTitle:e.properties.pageTitle.title[0]?.plain_text,pageId:e.properties.pageId.rich_text[0]?.plain_text,createdAt:e.properties.createdAt.rich_text[0]?.plain_text,reply:e.properties.reply.rich_text[0]?.plain_text,cfxAddress:e.properties.cfxAddress.rich_text[0]?.plain_text,nodeName:"#text",textContent:e.properties.textContent.rich_text[0]?.plain_text,tags:Array.from(e.properties.tags.multi_select,(e=>({color:e.color,name:e.name,id:e.id})))}]}(e)[0])),e}return[]}function a(e){return c(n,{filter:{property:"cfxAddress",rich_text:{equals:e}}})}function i(){return c(n,{filter:{property:"tags",multi_select:{is_not_empty:!0}},sorts:[{property:"createdAt",direction:"descending"}]})}chrome.runtime.onMessage.addListener((async function(r,d,l){const{cmd:p}=r;if(console.log("收到来自content-script的消息：",r,p),"mark-result"==p){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&t.cfxAddress.address&&(e=t.cfxAddress.address),e?function(e){let t={parent:{database_id:s},properties:{pageTitle:{title:[{type:"text",text:{content:e.pageTitle}}]},cfxAddress:{rich_text:[{type:"text",text:{content:e.cfxAddress}}]},pageId:{rich_text:[{type:"text",text:{content:e.pageId}}]},reply:{rich_text:[{type:"text",text:{content:e.reply}}]},textContent:{rich_text:[{type:"text",text:{content:e.textContent}}]},createdAt:{rich_text:[{type:"text",text:{content:e.createdAt}}]}}};return e.tags&&(t.properties.tags={multi_select:Array.from(e.tags,(e=>({name:e})))}),c("https://api.notion.com/v1/pages",t)}({...r.data,cfxAddress:e}).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"mark-push",data:e},(function(e){console.log(e)}))}))})):console.log("请登录")}else if("cfx-address"==p)e=r.data,e&&chrome.storage.sync.set({cfxAddress:{address:e,addressIsCheck:!1}});else if("get-address"==p){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&t.cfxAddress.address&&(e=t.cfxAddress.address),e&&l(e)}else"check-cfx-address"==p&&r.data?a(r.data).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"check-cfx-address-result",data:e,address:r.data},(function(e){}))}))})):"get-by-pageId"==p?(m=r.data,c(n,{filter:{property:"pageId",rich_text:{contains:m}}})).then((e=>{o().then((t=>{e=Array.from(e,(e=>(e.relate=Array.from(e.tags,(e=>t[e.name])).filter((t=>t&&t.pageId!=e.pageId)),e))),chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"get-by-pageId-result",data:e},(function(e){console.log(e)}))}))}))})):"new-reply"==p?(r.isMy&&r.address?a(r.address).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"new-reply",data:e},(function(e){console.log(e)}))}))})):function(e=null){let t=[{property:"createdAt",direction:"descending"}],r={and:[{property:"reply",rich_text:{is_not_empty:!0}}]};return"this_week"==e?(r.and.push({timestamp:"created_time",created_time:{this_week:{}}}),t=[{property:"tags",direction:"ascending"}]):"past_week"==e&&(r.and.push({timestamp:"created_time",created_time:{past_week:{}}}),t=[{property:"tags",direction:"ascending"}]),c(n,{filter:r,sorts:t})}(r.timestamp).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"new-reply",data:e},(function(e){console.log(e)}))}))})),i().then((e=>o(e)))):"open-login"==p&&0==t?(chrome.tabs.create({url:"newtab.html"}),t=!0):"find-by-tag"==p&&r.data&&function(e,t=5){return c(n,{filter:{property:"tags",multi_select:{contains:e}},sorts:[{property:"createdAt",direction:"descending"}],page_size:t})}(r.data).then((e=>{o(e).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"find-by-tag-result",data:e},(function(e){console.log(e)}))}))}))}));var m;l("我是后台，我已收到你的消息："+JSON.stringify(r))}))})();