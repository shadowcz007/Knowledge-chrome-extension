(()=>{console.log("This is the background page."),console.log("Put the background scripts here.",chrome.contextMenus);let e,t=!1;const{notionToken:r,notionDatabaseId:s}=chrome.runtime.getManifest().config;console.log(r,s),chrome.runtime.onInstalled.addListener((async()=>{chrome.contextMenus.create({id:"mark",title:"标注",type:"normal",contexts:["selection"]}),chrome.storage.local.get().then((function(e){null==e.data&&chrome.storage.local.set({data:["元宇宙","人工智能","web3","Web3","大模型"]})}),(function(e){console.log(e)}))})),chrome.contextMenus.onClicked.addListener((async(t,r)=>{const s=t.menuItemId;if(console.log(s,t,r),"keyword"==s){chrome.storage.local.get().then((function(e){console.log(e);let r=[...e.data,t.selectionText.trim()];chrome.storage.local.set({data:r})}),(function(e){console.log(e)}))}else if("mark"==s){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e?chrome.tabs.sendMessage(r.id,{cmd:"mark-run",tabId:r.id},(function(e){console.log(e)})):chrome.tabs.sendMessage(r.id,{cmd:"login",tabId:r.id},(function(e){console.log(e)}))}}));async function o(e="",t={}){const s=await((e,t={},r=1e4)=>{let s=!1;return new Promise((function(o,n){const a=setTimeout((function(){s=!0,o()}),r);fetch(e,t).then((e=>{clearTimeout(a),s||o(e)})).catch((e=>{o()}))}))})(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer "+r,"Content-Type":"application/json","Notion-Version":"2022-06-28"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});if(s&&200==s.status)return s.json()}function n(e,t=5){return o(`https://api.notion.com/v1/databases/${s}/query`,{filter:{property:"tags",multi_select:{contains:e}},sorts:[{property:"createdAt",direction:"descending"}],page_size:t})}function a(e){return[{pageTitle:e.properties.pageTitle.title[0]?.plain_text,pageId:e.properties.pageId.rich_text[0]?.plain_text,createdAt:e.properties.createdAt.rich_text[0]?.plain_text,reply:e.properties.reply.rich_text[0]?.plain_text,cfxAddress:e.properties.cfxAddress.rich_text[0]?.plain_text,nodeName:"#text",textContent:e.properties.textContent.rich_text[0]?.plain_text,tags:Array.from(e.properties.tags.multi_select,(e=>({color:e.color,name:e.name,id:e.id})))}]}chrome.runtime.onMessage.addListener((async function(r,c,i){if(console.log("收到来自content-script的消息：",r),"mark-result"==r.cmd){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e?function(e){let t={parent:{database_id:s},properties:{pageTitle:{title:[{type:"text",text:{content:e.pageTitle}}]},cfxAddress:{rich_text:[{type:"text",text:{content:e.cfxAddress}}]},pageId:{rich_text:[{type:"text",text:{content:e.pageId}}]},reply:{rich_text:[{type:"text",text:{content:e.reply}}]},textContent:{rich_text:[{type:"text",text:{content:e.textContent}}]},createdAt:{rich_text:[{type:"text",text:{content:e.createdAt}}]}}};return e.tags&&(t.properties.tags={multi_select:Array.from(e.tags,(e=>({name:e})))}),o("https://api.notion.com/v1/pages",t)}({...r.data,cfxAddress:e}).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"mark-push",data:e?a(e):null},(function(e){console.log(e)}))}))})):console.log("请登录")}else if("cfx-address"==r.cmd)e=r.data,e&&chrome.storage.sync.set({cfxAddress:e});else if("get-address"==r.cmd){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e&&i(e)}else"get-by-pageId"==r.cmd?(d=r.data,o(`https://api.notion.com/v1/databases/${s}/query`,{filter:{property:"pageId",rich_text:{contains:d}}})).then((e=>{let t={},r=Array.from(e&&e.results?e.results:[],(e=>{let r=a(e)[0];return Array.from(r.tags,(e=>t[e.name]=1)),r}));(function(e){let t={};return new Promise(((r,s)=>{e?n(e).then((s=>{Array.from(s.results,(r=>{let s=a(r)[0];t[s.pageId]={tag:e,pageTitle:s.pageTitle,pageId:s.pageId}})),r(Object.values(t))})):r()}))})(Object.keys(t)[0]).then((e=>{e&&Array.from(r,(t=>{t.relate=e.filter((e=>t.tags.filter((t=>t.name==e.tag)).length>0&&e.pageId!=t.pageId))})),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{cmd:"get-by-pageId-result",data:r},(function(e){console.log(e)}))}))}))})):"new-reply"==r.cmd?function(e=null){isQueryNotEmptyOfReply=!0;let t=`https://api.notion.com/v1/databases/${s}/query`,r=[{property:"createdAt",direction:"descending"}],n={and:[{property:"reply",rich_text:{is_not_empty:!0}}]};return"this_week"==e?(n.and.push({timestamp:"created_time",created_time:{this_week:{}}}),r=[{property:"tags",direction:"ascending"}]):"past_week"==e&&(n.and.push({timestamp:"created_time",created_time:{past_week:{}}}),r=[{property:"tags",direction:"ascending"}]),o(t,{filter:n,sorts:r})}(r.timestamp).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"new-reply",data:Array.from(e&&e.results?e.results:[],(e=>a(e)[0]))},(function(e){console.log(e)}))}));let t={};o(`https://api.notion.com/v1/databases/${s}/query`,{filter:{property:"tags",multi_select:{is_not_empty:!0}},sorts:[{property:"createdAt",direction:"descending"}]}).then((r=>{let s=[];r&&r.results&&(s=[...r.results]),e&&e.results&&(s=[...e.results,...s]),Array.from(s,(e=>{Array.from(a(e)[0].tags,(e=>{t[e.name]=1}))})),chrome.storage.local.get("tags").then(((e,r)=>{e&&e.tags&&Array.from(e.tags,(e=>t[e]=1)),chrome.storage.local.set({tags:Object.keys(t)})}))}))})):(r.cmd=0==t)?(chrome.tabs.create({url:"newtab.html"}),t=!0):"find-by-tag"==r.cmd&&r.data&&n(r.data).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"find-by-tag-result",data:Array.from(e&&e.results?e.results:[],(e=>a(e)[0]))},(function(e){console.log(e)}))}))}));var d;i("我是后台，我已收到你的消息："+JSON.stringify(r))}))})();