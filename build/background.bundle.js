(()=>{console.log("This is the background page."),console.log("Put the background scripts here.",chrome.contextMenus);let e,t=!1;const{notionToken:r,notionDatabaseId:o}=chrome.runtime.getManifest().config;console.log(r,o),chrome.runtime.onInstalled.addListener((async()=>{chrome.contextMenus.create({id:"mark",title:"标注",type:"normal",contexts:["selection"]}),chrome.storage.local.get().then((function(e){null==e.data&&chrome.storage.local.set({data:["元宇宙","人工智能","web3","Web3","大模型"]})}),(function(e){console.log(e)}))})),chrome.contextMenus.onClicked.addListener((async(t,r)=>{const o=t.menuItemId;if(console.log(o,t,r),"keyword"==o){chrome.storage.local.get().then((function(e){console.log(e);let r=[...e.data,t.selectionText.trim()];chrome.storage.local.set({data:r})}),(function(e){console.log(e)}))}else if("mark"==o){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e?chrome.tabs.sendMessage(r.id,{cmd:"mark-run",tabId:r.id},(function(e){console.log(e)})):chrome.tabs.sendMessage(r.id,{cmd:"login",tabId:r.id},(function(e){console.log(e)}))}}));function n(e=[]){let t={};return new Promise(((r,o)=>{chrome.storage.local.get("tags").then(((o,n)=>{o&&o.tags&&(t={...o.tags}),e&&e.length>0?(Array.from(e,(e=>{Array.from(e.tags,(r=>{t[r.name]=e}))})),chrome.storage.local.set({tags:t}).then((()=>r(t)))):r(t)}))}))}async function s(e="",t={}){const o=await((e,t={},r=1e4)=>{let o=!1;return new Promise((function(n,s){const a=setTimeout((function(){o=!0,n()}),r);fetch(e,t).then((e=>{clearTimeout(a),o||n(e)})).catch((e=>{n()}))}))})(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer "+r,"Content-Type":"application/json","Notion-Version":"2022-06-28"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});if(o&&200==o.status){let e=await o.json();return e&&e.properties&&(e.results=[{properties:e.properties}]),e=Array.from(e&&e.results?e.results:[],(e=>function(e){return[{pageTitle:e.properties.pageTitle.title[0]?.plain_text,pageId:e.properties.pageId.rich_text[0]?.plain_text,createdAt:e.properties.createdAt.rich_text[0]?.plain_text,reply:e.properties.reply.rich_text[0]?.plain_text,cfxAddress:e.properties.cfxAddress.rich_text[0]?.plain_text,nodeName:"#text",textContent:e.properties.textContent.rich_text[0]?.plain_text,tags:Array.from(e.properties.tags.multi_select,(e=>({color:e.color,name:e.name,id:e.id})))}]}(e)[0])),e}return[]}chrome.runtime.onMessage.addListener((async function(r,a,c){const{cmd:i}=r;if(console.log("收到来自content-script的消息：",r,i),"mark-result"==i){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e?function(e){let t={parent:{database_id:o},properties:{pageTitle:{title:[{type:"text",text:{content:e.pageTitle}}]},cfxAddress:{rich_text:[{type:"text",text:{content:e.cfxAddress}}]},pageId:{rich_text:[{type:"text",text:{content:e.pageId}}]},reply:{rich_text:[{type:"text",text:{content:e.reply}}]},textContent:{rich_text:[{type:"text",text:{content:e.textContent}}]},createdAt:{rich_text:[{type:"text",text:{content:e.createdAt}}]}}};return e.tags&&(t.properties.tags={multi_select:Array.from(e.tags,(e=>({name:e})))}),s("https://api.notion.com/v1/pages",t)}({...r.data,cfxAddress:e}).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"mark-push",data:e},(function(e){console.log(e)}))}))})):console.log("请登录")}else if("cfx-address"==i)e=r.data,e&&chrome.storage.sync.set({cfxAddress:e});else if("get-address"==i){const t=await chrome.storage.sync.get("cfxAddress");t&&t.cfxAddress&&(e=t.cfxAddress),e&&c(e)}else"get-by-pageId"==i?(d=r.data,s(`https://api.notion.com/v1/databases/${o}/query`,{filter:{property:"pageId",rich_text:{contains:d}}})).then((e=>{n().then((t=>{e=Array.from(e,(e=>(e.relate=Array.from(e.tags,(e=>t[e.name])).filter((t=>t&&t.pageId!=e.pageId)),e))),chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"get-by-pageId-result",data:e},(function(e){console.log(e)}))}))}))})):"new-reply"==i?function(e=null){let t=`https://api.notion.com/v1/databases/${o}/query`,r=[{property:"createdAt",direction:"descending"}],n={and:[{property:"reply",rich_text:{is_not_empty:!0}}]};return"this_week"==e?(n.and.push({timestamp:"created_time",created_time:{this_week:{}}}),r=[{property:"tags",direction:"ascending"}]):"past_week"==e&&(n.and.push({timestamp:"created_time",created_time:{past_week:{}}}),r=[{property:"tags",direction:"ascending"}]),s(t,{filter:n,sorts:r})}(r.timestamp).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"new-reply",data:e},(function(e){console.log(e)}))})),s(`https://api.notion.com/v1/databases/${o}/query`,{filter:{property:"tags",multi_select:{is_not_empty:!0}},sorts:[{property:"createdAt",direction:"descending"}]}).then((e=>n(e)))})):"open-login"==i&&0==t?(chrome.tabs.create({url:"newtab.html"}),t=!0):"find-by-tag"==i&&r.data&&function(e,t=5){return s(`https://api.notion.com/v1/databases/${o}/query`,{filter:{property:"tags",multi_select:{contains:e}},sorts:[{property:"createdAt",direction:"descending"}],page_size:t})}(r.data).then((e=>{n(e).then((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{cmd:"find-by-tag-result",data:e},(function(e){console.log(e)}))}))}))}));var d;c("我是后台，我已收到你的消息："+JSON.stringify(r))}))})();